name: Cycle Manager (Maintain 4 Active Slots)

on:
  pull_request:
    types: [closed]      # Jab PR close ho
  workflow_dispatch:     # Manual Button (Emergency ke liye)
  schedule:
    - cron: '0 */6 * * *' # Safety Check (Har 6 ghante)

permissions:
  issues: write

jobs:
  maintain-slots:
    runs-on: ubuntu-latest
    steps:
      - name: Ensure 4 Open Issues
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const TARGET_COUNT = 4; // Hamesha 4 issues active rahenge

            // 1. Check karo abhi kitne "Contribution Slot" issues open hain
            const openIssues = await github.rest.issues.listForRepo({
              owner,
              repo,
              state: 'open',
              labels: 'good first issue',
              per_page: 100
            });

            // Sirf wahi gino jinke title me "Contribution Slot" likha ho
            const activeSlots = openIssues.data.filter(issue => 
              issue.title.includes("Contribution Slot")
            );
            
            const currentCount = activeSlots.length;
            const needed = TARGET_COUNT - currentCount;

            console.log(`Currently Open: ${currentCount}`);
            console.log(`Need to Create: ${needed}`);

            // 2. Agar 4 se kam hain, to naye banao
            if (needed > 0) {
              for (let i = 0; i < needed; i++) {
                const slotId = Math.floor(Math.random() * 100000);
                
                await github.rest.issues.create({
                  owner,
                  repo,
                  title: `Contribution Slot: Open for Contribution [ID: ${slotId}]`,
                  body: `
                  ### ðŸ‘‹ Welcome to DevSynthetix First Contribution!
                  
                  This is an open slot for beginners to practice Open Source.
                  
                  **Your Task:**
                  1. Fork this repository.
                  2. Edit the file: \`contributors/README.md\`.
                  3. Add your GitHub Username to the list.
                  4. Create a Pull Request (PR).
                  
                  ---
                  ### âš ï¸ IMPORTANT
                  In your PR description, write:
                  > **Closes #<issue-number>** *(Check the number at the top)*
                  
                  ---
                  **Ready? Comment "Assign me" below!** ðŸš€
                  `,
                  labels: ['good first issue', 'help wanted', 'documentation']
                });
                
                // Thoda wait karo taaki GitHub API flood na ho
                await new Promise(r => setTimeout(r, 1000));
              }
              console.log(`${needed} new issues created! ðŸš€`);
            } else {
              console.log("Already 4 slots open. No action needed. âœ…");
            }
            
