name: Smart AI PR Handler

on:
  pull_request_target:
    types: [opened, synchronize, reopened]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  smart-ai-bot:
    runs-on: ubuntu-latest
    steps:
      - name: Smart AI Review & Merge
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const prNumber = context.issue.number;
            const actor = context.actor;
            const prBody = context.payload.pull_request.body || "";

            // 1. Closes # Check (Reminder)
            if (!prBody.toLowerCase().includes('closes #')) {
               await github.rest.issues.createComment({
                owner, repo, issue_number: prNumber,
                body: `ğŸ‘‹ **@${actor}**, Quick Reminder:\nPlease add \`Closes #<issue_number>\` to your PR description to auto-close the issue.`
              });
            }

            // 2. File Integrity Check
            const files = await github.rest.pulls.listFiles({ owner, repo, pull_number: prNumber });
            
            // âœ… AUTO-MERGE ALLOWED FILES (Safe List)
            const autoMergeFiles = ['contributors/README.md', 'reviews/feedback.md'];
            
            // âš ï¸ MANUAL REVIEW FILES (Admin List)
            const manualReviewFiles = ['README.md', 'CONTRIBUTING.md'];

            let isAutoMergeSafe = true;
            let needsManualReview = false;
            let invalidFiles = [];

            for (const file of files.data) {
              if (manualReviewFiles.includes(file.filename)) {
                isAutoMergeSafe = false;
                needsManualReview = true; // Sahi file hai, par Admin check karega
              } else if (!autoMergeFiles.includes(file.filename)) {
                isAutoMergeSafe = false; // Bilkul galat file (Reject)
                invalidFiles.push(file.filename);
              }
            }

            // --- SCENARIO A: Invalid Files (Reject) ---
            if (invalidFiles.length > 0) {
               await github.rest.issues.createComment({
                owner, repo, issue_number: prNumber,
                body: `ğŸš« **Security Alert:**\n\nYou edited files that are not open for contribution: \`${invalidFiles.join(', ')}\`.\nPlease only edit files mentioned in the Issue.`
              });
              await github.rest.issues.addLabels({ owner, repo, issue_number: prNumber, labels: ['invalid'] });
              return; 
            }

            // --- SCENARIO B: Manual Review Needed (Main Readme) ---
            if (needsManualReview) {
               await github.rest.issues.createComment({
                owner, repo, issue_number: prNumber,
                body: `ğŸ‘€ **Manual Review Required:**\n\nGood job @${actor}! Since you edited a core documentation file (\`README.md\`), a maintainer needs to verify the grammar/text before merging.\n\nâœ… **Status:** AI Check Passed. Waiting for Admin Merge.`
              });
              await github.rest.issues.addLabels({ owner, repo, issue_number: prNumber, labels: ['needs-review'] });
              return; // Bot yahi ruk jayega
            }

            // --- SCENARIO C: Auto Merge (Contributors & Reviews) ---
            if (isAutoMergeSafe) {
              await github.rest.pulls.createReview({
                owner, repo, pull_number: prNumber, event: 'APPROVE', body: "âœ… **AI Review:** Safe to merge."
              });

              try {
                await github.rest.pulls.merge({
                  owner, repo, pull_number: prNumber, merge_method: 'squash'
                });
                await github.rest.issues.createComment({
                  owner, repo, issue_number: prNumber,
                  body: `ğŸ‰ **Merged!**\n\nCongratulations @${actor}! Your contribution is live. ğŸ†`
                });
              } catch (e) {
                console.log(e);
              }
            }
            
