name: Smart AI PR Handler

on:
  pull_request_target:
    types: [opened, synchronize, reopened]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  smart-ai-bot:
    runs-on: ubuntu-latest
    steps:
      - name: Smart AI Review & Merge
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const prNumber = context.issue.number;
            const actor = context.actor;
            const prBody = context.payload.pull_request.body || "";

            // 1. Check for "Closes #" (Reminder)
            if (!prBody.toLowerCase().includes('closes #')) {
               await github.rest.issues.createComment({
                owner, repo, issue_number: prNumber,
                body: `ğŸ‘‹ **@${actor}**, Quick Reminder:\nPlease add \`Closes #<issue_number>\` to your PR description.`
              });
            }

            // 2. File Security Scan (Critical Step)
            const files = await github.rest.pulls.listFiles({ owner, repo, pull_number: prNumber });
            
            // Files allowed for Auto-Merge
            const autoMergeFiles = ['contributors/README.md', 'reviews/feedback.md'];
            // Files allowed for Manual Review
            const manualReviewFiles = ['README.md', 'CONTRIBUTING.md'];

            let isAutoMergeSafe = true;
            let needsManualReview = false;
            let invalidFiles = [];

            for (const file of files.data) {
              
              // ğŸš¨ SECURITY RULE: Reject .github changes immediately
              if (file.filename.startsWith('.github/')) {
                  await github.rest.issues.createComment({
                    owner, repo, issue_number: prNumber,
                    body: `ğŸ›‘ **Security Breach Detected:**\n\n@${actor}, modifying system files inside \`.github/\` is **Strictly Prohibited**.\n\n**Action:** ğŸ”’ This PR is automatically rejected and closed.`
                  });
                  
                  // PR ko turant Close (Reject) kar do
                  await github.rest.pulls.update({
                    owner, repo, pull_number: prNumber, state: 'closed'
                  });
                  
                  await github.rest.issues.addLabels({ owner, repo, issue_number: prNumber, labels: ['security-risk', 'invalid'] });
                  return; // Yahi ruk jao, aage kuch mat karo
              }

              // Normal File Checking
              if (manualReviewFiles.includes(file.filename)) {
                isAutoMergeSafe = false;
                needsManualReview = true; 
              } else if (!autoMergeFiles.includes(file.filename)) {
                isAutoMergeSafe = false;
                invalidFiles.push(file.filename);
              }
            }

            // --- SCENARIO A: Invalid Files (Unknown files) ---
            if (invalidFiles.length > 0) {
               await github.rest.issues.createComment({
                owner, repo, issue_number: prNumber,
                body: `ğŸš« **Invalid Files:**\n\nYou edited files that are not part of the contribution list: \`${invalidFiles.join(', ')}\`.\nPlease revert these changes.`
              });
              await github.rest.issues.addLabels({ owner, repo, issue_number: prNumber, labels: ['invalid'] });
              return; 
            }

            // --- SCENARIO B: Manual Review Needed ---
            if (needsManualReview) {
               await github.rest.issues.createComment({
                owner, repo, issue_number: prNumber,
                body: `ğŸ‘€ **Manual Review Required:**\n\nYou edited core documentation. A maintainer will verify the changes before merging.`
              });
              await github.rest.issues.addLabels({ owner, repo, issue_number: prNumber, labels: ['needs-review'] });
              return; 
            }

            // --- SCENARIO C: Auto Merge (Safe) ---
            if (isAutoMergeSafe) {
              await github.rest.pulls.createReview({
                owner, repo, pull_number: prNumber, event: 'APPROVE', body: "âœ… **AI Review:** Safe to merge."
              });

              try {
                await github.rest.pulls.merge({
                  owner, repo, pull_number: prNumber, merge_method: 'squash'
                });
                await github.rest.issues.createComment({
                  owner, repo, issue_number: prNumber,
                  body: `ğŸ‰ **Merged!**\n\nCongratulations @${actor}! Your contribution is live. ğŸ†`
                });
              } catch (e) {
                console.log(e);
              }
            }
            
